{% load static %}

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Iniciar sesión</title>
    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Estilos personalizados -->
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            background-color: #f8f9fa;
        }

        .container-login {
            max-width: 400px;
            margin: 5rem auto;
            background: #fff;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 0 15px rgba(0,0,0,0.05);
        }

        .btn-purple {
            background-color: #7b61ff;
            color: white;
            border-radius: 10px;
            font-weight: 500;
        }

        .btn-purple:hover {
            background-color: #684edc;
        }

        .form-control {
            border-radius: 0.5rem;
        }

        .logo-text {
            font-size: 1.5rem;
            font-weight: bold;
            color: #7b61ff;
        }

        .top-bar {
            padding: 1rem 2rem;
            background-color: #fff;
            border-bottom: 1px solid #ddd;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .form-text-error {
            color: red;
            font-size: 0.9rem;
        }

        a {
            color: #7b61ff;
        }

        a:hover {
            text-decoration: underline;
        }
    </style>

    <!-- Importar Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-auth.js";
        import firebaseConfig from "/static/js/firebase-config.js";  // Ruta correcta para Django

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);

        // Manejo del formulario de inicio de sesión
        document.addEventListener('DOMContentLoaded', () => {
            console.log('El DOM está completamente cargado');
            const form = document.getElementById('login-form');
            form.addEventListener('submit', function(event) {
                event.preventDefault();  // Esto previene el envío tradicional del formulario

                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;

                signInWithEmailAndPassword(auth, email, password)
                    .then((userCredential) => {
                        const user = userCredential.user;
                        const uid = user.uid;

                        // Obtener el idToken
                        user.getIdToken().then(idToken => {
                            console.log("idToken obtenido: ", idToken);  // Aquí confirmamos que se obtiene el idToken

                            // Guardar el idToken en sessionStorage y localStorage
                            sessionStorage.setItem('idToken', idToken);
                            localStorage.setItem('idToken', idToken);

                            // Enviar el UID al backend
                            fetch('/login/', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-CSRFToken': '{{ csrf_token }}'
                                },
                                body: JSON.stringify({ uid: uid })
                            })
                            .then(response => response.json())
                            .then(data => {
                                if (data.success) {
                                    window.location.href = '/inicio';  // Redirige después del login exitoso
                                } else {
                                    document.getElementById('error-message').innerText = data.error;
                                }
                            })
                            .catch(error => {
                                console.error('Error al enviar UID:', error);
                            });
                        });
                    })
                    .catch((error) => {
                        const errorMessage = error.message;
                        document.getElementById('error-message').innerText = errorMessage;
                    });
            });

            // Asegúrate de que el token sigue en localStorage después de las redirecciones
            console.log("idToken en localStorage en la nueva página:", localStorage.getItem('idToken'));
        });
    </script>

</head>
<body>
    <!-- Barra superior -->
    <div class="top-bar">
        <div class="logo-text">🌸 TaskManagerPro</div>
        <a href="{% url 'registro' %}" class="btn btn-purple">Registrarse</a>
    </div>

    <!-- Contenedor de login -->
    <div class="container-login">
        <h2 class="text-center mb-4">Iniciar sesión</h2>

        <!-- Mostrar los mensajes de error -->
        {% if messages %}
            <div class="alert alert-danger">
                {% for message in messages %}
                    <p>{{ message }}</p>
                {% endfor %}
            </div>
        {% endif %}

        <div id="error-message" class="form-text-error text-center mb-3"></div>

        <form method="POST" id="login-form">
            {% csrf_token %}
            <div class="mb-3">
                <input type="email" id="email" name="email" class="form-control" placeholder="Correo electrónico" required>
            </div>
            <div class="mb-3">
                <input type="password" id="password" name="password" class="form-control" placeholder="Contraseña" required>
            </div>
            <div class="d-grid">
                <button type="submit" class="btn btn-purple">Iniciar sesión</button>
            </div>
        </form>

        <p class="mt-3 text-center">
            <a href="{% url 'password_reset' %}">¿Olvidaste tu contraseña?</a>
        </p>

        <p class="mt-3 text-center">
            ¿No tienes cuenta? <a href="{% url 'registro' %}">Regístrate aquí</a>
        </p>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
