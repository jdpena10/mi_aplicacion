{% load tz %}
{% block content %}

<h2 style="text-align: center; margin-bottom: 30px;">{{ tablero.nombre }}</h2>
<a href="{% url 'listar_tableros' %}" class="volver-link" style="margin-left: 20px; text-decoration: none;">
    ‚¨Ö Volver a la lista de tableros
</a>


<a href="{% url 'ver_calendario' tablero_id %}" class="volver-link" style="margin-left: 20px; text-decoration: none;">
    üìÖVer Calendario
</a>

{% if rol == 'premium' or rol == 'administrador' %}
<a href="{% url 'ver_resumen' tablero_id %}" class="volver-link" style="margin-left: 20px; text-decoration: none;">
    üìãResumen de tareas
</a>
{% endif %}

<a href="javascript:void(0)" onclick="toggleCompartirForm()" style="margin-left: 20px; text-decoration: none;">
    üì§ Compartir Tablero
</a>

<a href="{% url 'simular_pago_formulario' %}" class="volver-link" style="margin-left: 500px; text-decoration: none;">
   üèÖ Conviertete en usuario Premium
</a>

{% if mensaje_compartir %}
<p style="color: green; margin-top: 10px;">{{ mensaje_compartir }}</p>
{% endif %}


<div class="tablero-container" id="listas">
    {% for lista_id, lista in listas.items %}
    <div class="lista" data-id="{{ lista_id }}">
        <!-- Formulario para eliminar la lista -->
        <form method="POST" action="{% url 'eliminar_lista' tablero_id=tablero_id lista_id=lista_id %}" style="text-align: right;" onsubmit="return confirmarEliminacionLista();">
            {% csrf_token %}
            <button type="submit" class="btn-eliminar-lista">üóëÔ∏è</button>
        </form>

        <h4 class="lista-titulo">{{ lista.nombre }}</h4>

        <div class="tarjetas">
            {% for tarjeta_id, tarjeta in lista.tarjetas.items %}
            <div class="tarjeta" data-id="{{ tarjeta_id }}"
                data-fecha-limite="{{ tarjeta.fecha_limite|default_if_none:'' }}"
                data-completada="{{ tarjeta.completada|yesno:'true,false' }}"
                style="background-color: {{ tarjeta.color }}">
                {% if tarjeta.completada %}
                <span class="badge completada-badge">‚úî Completada</span>
                {% endif %}
                <strong>{{ tarjeta.titulo }}</strong><br>
                <small>{{ tarjeta.descripcion }}</small><br>
                {% if tarjeta.fecha_limite %}
                <small class="fecha-limite">üìÖ {{ tarjeta.fecha_limite }}</small><br>
                {% endif %}
                <!-- Botones de editar y eliminar -->
                <button class="btn-editar-tarjeta"
                    onclick="editarTarjeta('{{ tarjeta_id }}', '{{ lista_id }}', '{{ tablero_id }}')">‚úèÔ∏è Editar</button>
                <button class="btn-eliminar-tarjeta"
                    onclick="eliminarTarjeta('{{ tarjeta_id }}', '{{ lista_id }}', '{{ tablero_id }}')">üóëÔ∏è
                    Eliminar</button>
            </div>
            {% empty %}
            <p>No hay tarjetas.</p>
            {% endfor %}
        </div>

        <!-- Mostrar formulario para agregar tarjeta -->
        <button class="btn-mostrar-formulario" onclick="mostrarFormularioTarjeta('{{ lista_id }}')">‚ûï Agregar
            Tarjeta</button>

        <!-- Formulario para agregar tarjeta -->
        <form method="POST" action="{% url 'agregar_tarjeta' tablero_id=tablero_id lista_id=lista_id %}"
            class="formulario-tarjeta" id="formulario-{{ lista_id }}" style="display: none;">
            {% csrf_token %}
            <input type="text" name="titulo" placeholder="T√≠tulo" required>
            <textarea name="descripcion" placeholder="Descripci√≥n" rows="2" required></textarea>
            <span>Seleccione un color:</span>
            <input type="color" name="color" value="#ffffff" required>
            <span>Seleccione una fecha limite para la tarea:</span>
            <input type="date" name="fecha_limite" required>
            <input type="hidden" name="orden" value="0">
            <button type="submit" class="btn-agregar">‚ûï Agregar</button>
        </form>
    </div>
    {% endfor %}

    <!-- Nueva lista -->
    <div class="lista nueva-lista">
        <form method="POST" action="">
            {% csrf_token %}
            <input type="text" name="nombre" placeholder="Nombre de la lista" required>
            <input type="hidden" name="orden" value="0">
            <button type="submit" class="btn-nueva-lista">‚ûï Agregar Lista</button>
        </form>
    </div>

    <!-- Formulario para compartir tablero -->
    <div id="form-compartir" style="margin-top: 10px; {% if not mostrar_form_compartir %}display: none;{% endif %}">
        <form method="POST" action="{% url 'compartir_tablero' tablero_id=tablero_id %}">
            {% csrf_token %}
            <input type="email" name="email" placeholder="Correo para compartir" required>
            <button type="submit">Enviar Invitaci√≥n</button>
        </form>
    </div>

</div>

<!-- Modal de edici√≥n de tarjeta -->
<div id="modal-editar-tarjeta" style="display: none;">
    <div class="modal-contenido">
        <h3>Editar Tarjeta</h3>
        <form id="formulario-editar-tarjeta">
            {% csrf_token %}
            <input type="text" id="editar-titulo" name="titulo" placeholder="T√≠tulo" required><br>
            <textarea id="editar-descripcion" name="descripcion" placeholder="Descripci√≥n" rows="2"></textarea><br>
            <input type="color" id="editar-color" name="color"><br>
            <input type="date" id="editar-fecha-limite" name="fecha_limite"><br>
            <input type="checkbox" id="editar-completada" name="completada">
            <label for="editar-completada">Marcar como completada</label><br>
            <button type="submit" class="btn-editar">Guardar Cambios</button>
            <button type="button" class="btn-cerrar" onclick="cerrarModal()">Cancelar</button>
        </form>
    </div>
</div>

<style>
    body {
        background: #f0f4f8;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    .tablero-container {
        display: flex;
        gap: 20px;
        overflow-x: auto;
        padding: 20px;
    }

    .lista {
        background: #ffffff;
        border-radius: 12px;
        padding: 16px;
        min-width: 270px;
        max-height: 85vh;
        overflow-y: auto;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
        position: relative;
    }

    .lista-titulo {
        font-size: 18px;
        color: #333;
        margin-bottom: 12px;
        border-bottom: 1px solid #e0e0e0;
        padding-bottom: 6px;
    }

    .btn-eliminar-lista {
        background: transparent;
        border: none;
        color: #d9534f;
        font-size: 16px;
        cursor: pointer;
    }

    .tarjeta {
        background: #fafafa;
        border-radius: 10px;
        padding: 12px;
        margin-bottom: 12px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
    }

    .completada-badge {
        background-color: #28a745;
        color: white;
        padding: 4px 8px;
        font-size: 12px;
        border-radius: 8px;
        display: inline-block;
        margin-bottom: 8px;
    }

    .fecha-limite {
        font-size: 12px;
        color: #555;
        margin-top: 4px;
        display: inline-block;
    }

    .acciones {
        margin-top: 10px;
        display: flex;
        gap: 10px;
    }

    .btn-editar,
    .btn-eliminar {
        font-size: 13px;
        padding: 4px 8px;
        border-radius: 5px;
        text-decoration: none;
        transition: background-color 0.2s;
    }

    .btn-editar {
        background-color: #ffc107;
        color: #333;
    }

    .btn-editar:hover {
        background-color: #e0a800;
    }

    .btn-eliminar {
        background-color: #dc3545;
        color: white;
    }

    .btn-eliminar:hover {
        background-color: #c82333;
    }

    .formulario-tarjeta {
        margin-top: 10px;
    }

    .formulario-tarjeta input[type="text"],
    .formulario-tarjeta textarea,
    .formulario-tarjeta input[type="color"],
    .formulario-tarjeta input[type="date"] {
        width: 100%;
        padding: 6px;
        margin-bottom: 6px;
        border-radius: 6px;
        border: 1px solid #ccc;
    }

    .btn-agregar {
        width: 100%;
        background-color: #d4defa;
        color: black;
        border: none;
        padding: 8px;
        border-radius: 6px;
        cursor: pointer;
        font-weight: bold;
    }

    .btn-agregar:hover {
        background-color: #698bf3;
    }

    .btn-mostrar-formulario {
        width: 100%;
        margin-top: 10px;
        background-color: #17a2b8;
        color: white;
        padding: 8px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
    }

    .btn-mostrar-formulario:hover {
        background-color: #138496;
    }

    .nueva-lista {
        background-color: #eef1f7;
        border: 2px dashed #ccc;
        text-align: center;
        color: #5e6c84;
        font-weight: bold;
    }

    .btn-nueva-lista {
        background-color: #007bff;
        color: white;
        padding: 10px;
        border: none;
        border-radius: 8px;
        margin-top: 12px;
        cursor: pointer;
        font-weight: bold;
    }

    .btn-nueva-lista:hover {
        background-color: #0056b3;
    }

    .vencida-badge {
        background-color: #e63946;
        color: white;
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 12px;
        display: inline-block;
        margin-bottom: 4px;
    }
</style>

<script>

    // Funci√≥n para crear fecha sin hora a partir de string "YYYY-MM-DD"
    function soloFecha(dateStr) {
        const partes = dateStr.split('-'); 
        return new Date(partes[0], partes[1] - 1, partes[2]); 
    }

    document.addEventListener("DOMContentLoaded", function () {
      const hoy = new Date();
      const yyyy = hoy.getFullYear();
      const mm = String(hoy.getMonth() + 1).padStart(2, '0'); // Meses de 0-11
      const dd = String(hoy.getDate()).padStart(2, '0');
      const fechaMinima = `${yyyy}-${mm}-${dd}`;

      // Aplica la fecha m√≠nima a todos los inputs de tipo date
      document.querySelectorAll("input[type='date']").forEach(input => {
        input.min = fechaMinima;
      });
    });


    document.addEventListener("DOMContentLoaded", function () {

        // Mostrar u ocultar el formulario de crear tarjeta
        function mostrarFormularioTarjeta(listaId) {
            const formulario = document.getElementById('formulario-' + listaId);
            formulario.style.display = (formulario.style.display === "none") ? "block" : "none";
        }

        // Convertir color RGB a hexadecimal
        function rgbToHex(rgb) {
            const result = rgb.match(/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/);
            if (result) {
                return "#" + ("0" + parseInt(result[1], 10).toString(16)).slice(-2)
                    + ("0" + parseInt(result[2], 10).toString(16)).slice(-2)
                    + ("0" + parseInt(result[3], 10).toString(16)).slice(-2);
            }
            return rgb; // Si ya es un color HEX, lo devuelve igual
        }

        // Cerrar el modal de edici√≥n
        function cerrarModal() {
            document.getElementById('modal-editar-tarjeta').style.display = "none";
        }

        // Editar tarjeta
        window.editarTarjeta = function (tarjetaId, listaId, tableroId) {
            const tarjeta = document.querySelector(`.tarjeta[data-id='${tarjetaId}']`);
            const titulo = tarjeta.querySelector('strong').innerText;
            const descripcion = tarjeta.querySelector('small').innerText;
            const color = tarjeta.style.backgroundColor || '#ffffff';
            const fechaLimite = tarjeta.getAttribute('data-fecha-limite');
            const completada = tarjeta.getAttribute('data-completada') === 'true';

            document.getElementById('editar-titulo').value = titulo;
            document.getElementById('editar-descripcion').value = descripcion;
            document.getElementById('editar-color').value = rgbToHex(color);
            document.getElementById('editar-fecha-limite').value = fechaLimite;
            document.getElementById('editar-completada').checked = completada;

            document.getElementById('modal-editar-tarjeta').style.display = "block";

            document.getElementById('formulario-editar-tarjeta').onsubmit = function (event) {
                event.preventDefault();
                const newTitulo = document.getElementById('editar-titulo').value;
                const newDescripcion = document.getElementById('editar-descripcion').value;
                const newColor = document.getElementById('editar-color').value;
                const newFechaLimite = document.getElementById('editar-fecha-limite').value;
                const nuevaCompletada = document.getElementById('editar-completada').checked;
                const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

                fetch('/editar_tarjeta/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken,
                    },
                    body: JSON.stringify({
                        tarjeta_id: tarjetaId,
                        lista_id: listaId,
                        tablero_id: tableroId,
                        titulo: newTitulo,
                        descripcion: newDescripcion,
                        color: newColor,
                        fecha_limite: newFechaLimite,
                        completada: nuevaCompletada
                    })
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            tarjeta.querySelector('strong').innerText = newTitulo;
                            tarjeta.querySelector('small').innerText = newDescripcion;
                            tarjeta.style.backgroundColor = newColor;
                            tarjeta.setAttribute('data-fecha-limite', newFechaLimite);
                            tarjeta.setAttribute('data-completada', nuevaCompletada);

                            // Mostrar o quitar badge de completada
                            let existingBadge = tarjeta.querySelector('.badge-completada');
                            let existingVencidaBadge = tarjeta.querySelector('.vencida-badge');

                            // Usar la funci√≥n soloFecha para comparar sin horas
                            const fechaLimiteDate = soloFecha(newFechaLimite);
                            const hoy = new Date();
                            const hoySinHora = new Date(hoy.getFullYear(), hoy.getMonth(), hoy.getDate());

                            // --- Logs para debug ---
                            console.log('fechaLimite original:', newFechaLimite);
                            console.log('fechaLimiteDate:', fechaLimiteDate.toISOString());
                            console.log('hoySinHora:', hoySinHora.toISOString());

                            if (nuevaCompletada) {
                                if (!existingBadge) {
                                    const badge = document.createElement('span');
                                    badge.className = 'badge badge-completada';
                                    badge.innerText = '‚úÖ Completada';
                                    tarjeta.prepend(badge);
                                }
                            } else if (existingBadge) {
                                existingBadge.remove();
                            }

                            // Verificar si la tarjeta est√° vencida usando fechas sin hora
                            if (fechaLimiteDate < hoySinHora) {
                                if (!existingVencidaBadge) {
                                    const badge = document.createElement('span');
                                    badge.className = 'badge vencida-badge';
                                    badge.innerText = '‚õî Vencida';
                                    tarjeta.prepend(badge);
                                }
                            } else if (existingVencidaBadge) {
                                existingVencidaBadge.remove();
                            }

                            alert('Tarjeta actualizada con √©xito');
                            cerrarModal();
                        } else {
                            alert('Error al actualizar la tarjeta');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Hubo un error al actualizar la tarjeta');
                    });
            };
        };

        // Eliminar tarjeta
        window.eliminarTarjeta = function (tarjetaId, listaId, tableroId) {
            if (confirm("¬øEst√°s seguro de que deseas eliminar esta tarjeta?")) {
                const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

                fetch('/eliminar_tarjeta/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken,
                    },
                    body: JSON.stringify({
                        tarjeta_id: tarjetaId,
                        lista_id: listaId,
                        tablero_id: tableroId
                    })
                })
                    .then(response => {
                        if (!response.ok) throw new Error('Respuesta no v√°lida del servidor');
                        return response.json();
                    })
                    .then(data => {
                        if (data.success) {
                            const tarjeta = document.querySelector(`.tarjeta[data-id='${tarjetaId}']`);
                            tarjeta.remove();
                            alert('Tarjeta eliminada con √©xito.');
                        } else {
                            alert('Error: ' + (data.error || 'No se pudo eliminar la tarjeta.'));
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Hubo un error al eliminar la tarjeta.');
                    });
            }
        };

        // Marcar tarjetas vencidas al cargar la p√°gina
        const tarjetas = document.querySelectorAll('.tarjeta');
        tarjetas.forEach(function (tarjeta) {
            const fechaLimite = tarjeta.getAttribute('data-fecha-limite');
            const completada = tarjeta.getAttribute('data-completada') === 'true';

            if (fechaLimite && !completada) {
                // Usar la funci√≥n soloFecha para comparar sin horas
                const fechaLimiteDate = soloFecha(fechaLimite);
                const hoy = new Date();
                const hoySinHora = new Date(hoy.getFullYear(), hoy.getMonth(), hoy.getDate());

                // --- Logs para debug ---
                console.log('fechaLimite original:', fechaLimite);
                console.log('fechaLimiteDate:', fechaLimiteDate.toISOString());
                console.log('hoySinHora:', hoySinHora.toISOString());

                if (fechaLimiteDate < hoySinHora) {
                    const badge = document.createElement('span');
                    badge.className = 'badge vencida-badge';
                    badge.innerText = '‚õî Vencida';
                    tarjeta.prepend(badge);
                }
            }
        });

        // Exponer funciones globales necesarias
        window.mostrarFormularioTarjeta = mostrarFormularioTarjeta;
        window.cerrarModal = cerrarModal;
    });

    // Funci√≥n para mostrar/ocultar el formulario de compartir tablero
    function toggleCompartirForm() {
        const form = document.getElementById('form-compartir');
        if (form.style.display === 'none' || form.style.display === '') {
            form.style.display = 'block';
        } else {
            form.style.display = 'none';
        }
    }
    // Exponer la funci√≥n globalmente para que funcione el onclick en el bot√≥n
    window.toggleCompartirForm = toggleCompartirForm;

    // FUNCIONALIDAD DE ARRASTRAR Y SOLTAR LISTAS
    const tablero = document.getElementById("listas");
    let draggedLista = null;

    document.querySelectorAll('.lista').forEach(lista => {
        // Evitar que la "nueva lista" sea arrastrable
        if (lista.classList.contains('nueva-lista')) return;

        lista.setAttribute('draggable', 'true');

        lista.addEventListener('dragstart', function (e) {
            draggedLista = this;
            this.style.opacity = '0.5';
        });

        lista.addEventListener('dragend', function () {
            this.style.opacity = '1';
            draggedLista = null;
        });

        lista.addEventListener('dragover', function (e) {
            e.preventDefault(); // Necesario para permitir el drop
        });

        lista.addEventListener('drop', function (e) {
            e.preventDefault();
            if (draggedLista && draggedLista !== this) {
                const todasLasListas = [...tablero.querySelectorAll('.lista:not(.nueva-lista)')];
                const indiceArrastrada = todasLasListas.indexOf(draggedLista);
                const indiceSoltar = todasLasListas.indexOf(this);

                if (indiceArrastrada < indiceSoltar) {
                    tablero.insertBefore(draggedLista, this.nextSibling);
                } else {
                    tablero.insertBefore(draggedLista, this);
                }
            }
        });
    });

    // Confirmaci√≥n doble para eliminar lista
    function confirmarEliminacionLista() {
        if (confirm("¬øEst√°s seguro de que deseas eliminar toda la lista y todas sus tarjetas?")) {
            return confirm("Esta acci√≥n no se puede deshacer. ¬øRealmente quieres continuar?");
        }
        return false;
    }
    window.confirmarEliminacionLista = confirmarEliminacionLista;

</script>

{% endblock %}







